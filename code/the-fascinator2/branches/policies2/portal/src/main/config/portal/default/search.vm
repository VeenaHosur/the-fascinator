#macro(displayFacetTree $facetTreeId $facetTreeTitle)
  <div class="mainmenu ui-helper-hidden">
    <div class="mainmenu-top"></div>
    <div class="mainmenu-heading">$facetTreeTitle</div>
    <div id="$facetTreeId" class="ui-helper-clearfix"></div>
  </div>
#end
#macro(displayFacet $facetFieldKey)
  #set($facetCounts = $self.getFacetCounts($facetFieldKey))
  #if($facetCounts.size() > 0)
  <div class="mainmenu">
    <div class="mainmenu-top"></div>
    <div class="mainmenu-heading">$self.getFacetName($facetFieldKey)</div>
    <ul class="facet-list">
    #foreach($facetCountKey in $facetCounts.keySet())
      #set($facetCount = $facetCounts.get($facetCountKey))
      #set($facetQuery = $self.getFacetQuery($facetFieldKey, $facetCountKey))
      #set($selected = $self.isSelected($facetQuery))
      <li#if($selected) class="selected"#end>
      #if($self.isPortalQueryFacet($facetQuery))
        <span class="selected">$facetCountKey</span> ($facetCount)
      #else
        #if($selected)
          #set($facetClass = "remove-facet selected")
        #else
          #set($facetClass = "add-facet")
        #end
        <a class="$facetClass" href="#" rel='$facetFieldKey:"$facetCountKey"'>$page.escapeText($facetCountKey)</a> ($facetCount)
      #end
      </li>
    #end
    </ul>
  </div>
  #end
#end
#set($pageTitle = 'Search')
#set($query = $self.query)
#set($paging = $self.paging)
#if($query)
  #set($atomLink = "$portalPath/feed/atom?query=$query")
#else
  #set($atomLink = "$portalPath/feed/atom")
#end
#set($pageHeader = '
  <link rel="alternate" type="application/atom+xml" href="'+ $atomLink +'" />
  <script type="text/javascript" src="' + $portalPath + '/js/jquery.tree.min.js"></script>
  <script type="text/javascript" src="' + $portalPath + '/js/jquery.truncate.js"></script>
')
<table class="layout">
  <tbody>
    <tr>
      <td class="leftcol">
        <div class="columnbox">
          <div class="mainmenu">
            <div class="mainmenu-top"></div>
            <div class="mainmenu-heading">USQ Policies</div>
            <ul class="menu-list">
              <li><a href="$portalPath/home">Home</a></li>
              <li class="selected">Search</li>
              <li><a href="$portalPath/help">Help</a></li>
            </ul>
          </div>
          #if($self.hasSelectedFacets() || $query != "")
            <div class="mainmenu">
              <div class="mainmenu-top"></div>
              <div class="mainmenu-heading">Actions</div>
              <ul>
                #if($query != "")
                  <li><a href="$portalPath/search">Clear search</a></li>
                #end
                #if($self.hasSelectedFacets())
                  <li><a id="clear-facets" href="#">Clear selection</a></li>
                #end
              </ul>
            </div>
          #end
          #displayFacetTree("title_group", "Title")
          #displayFacetTree("policy_type", "Policy type")
          #displayFacet("f_usq_document_type")
          #displayFacet("f_usq_document_div_dept_office")
          <div class="advanced">
            <span class="ui-icon ui-icon-triangle-1-e icon"></span>
            <h2>Advanced</h2>
            <div class="ui-helper-hidden">
              #displayFacetTree("effective_date", "Effective Date")
              #displayFacet("f_usq_document_committee_owner")
              #displayFacet("f_usq_document_responsible_position")
            </div>
          </div>
        </div>
      </td>
      <td class="middlecol">
        <h2 class="content-title">Search</h2>
        <div class="search-box">
          <form action="$portalPath/search" id="search-form" method="post">
            <input type="text" name="query" size="70" value="$!query" />
            <input type="submit" name="search" value="Search" />
            #if($self.result and $paging.totalFound > 0)
              <p class="search-message">Displaying <strong>${paging.startNum}</strong> to <strong>${paging.endNum}</strong> of <strong>${paging.totalFound}</strong> records (in $self.queryTime seconds)</p>
            #else
              <p class="search-error">No results have been found for the entered search. Please try again.</p>
            #end
            #parse($page.getTemplate("search-paging.vm"))
          </form>
        </div>
        #if($self.result and $paging.totalFound > 0)
        <div class="result-list">
          <h2>Results</h2>
          <ul>
          #foreach($item in $self.result.getList("response/docs"))
            #set($id = $item.get("id"))
            #set($dcTitle = "")
            #set($dcTitle = $item.get("dc_title").get(0))
            #if($dcTitle.trim() != "")
              #set($title = $dcTitle)
            #else
              #set($title = $self.getFileName($id))
            #end
            #set($description = "")
            #set($description = $item.get("usq_document_purpose").get(0))
            <li id="$id">
              <h3><a href="detail/$id">$page.escapeText($title)</a></h3>
              <p class="item-description">$page.escapeText($!description)</p>
            </li>
          #end
          </ul>
        </div>
        #end
      </td>
    </tr>
  </tbody>
</table>
<script type="text/javascript">
$(function() {
    addActionParam("query", "$!query");
    
    // hierarchical facet trees
    function createTree(selector, facetField) {
        var tree = jQuery.tree.create();
        tree.init($(selector), {
            data: {
                type: "json",
                opts: {
                    url: "$portalPath/search-tree.ajax?facet.field=" + facetField
                }
            },
            selected: $self.selectedFacetIds,
            ui: {
                animation: 250,
                dots: false,
                theme_name: "checkbox"
            },
            opened: [],
            plugins: {
                checkbox: {},
                cookie: {
                    prefix: "tf_tree_" + facetField
                }
            },
            callback: {
                beforedata: function(node, tree) {
                    return {
                        id: $(node).attr("id") || 0,
                        query: $("#query").val()
                    };
                },
                onchange: function(node, tree) {
                    $(node).children("a").removeClass("clicked");
                    $(node).children("a").toggleClass("checked");
                },
                onload: function(tree) {
                    tree.container.find("a").bind("click", function() {
                        var checked = $(this).hasClass("checked") == false;
                        doAction(checked ? "add_fq" : "remove_fq", $(this).parent().attr("fq"));
                    });
                    var nodeCount = $("#title_group").find("li").length;
                    if (nodeCount > 0) {
                        $(selector).parent("div").show();
                    }
                }
            }
        });
        return tree;
    }
    createTree("#title_group", "f_title_group");
    createTree("#policy_type", "f_usq_document_policy_type");
    createTree("#effective_date", "usq_document_effective_date");
    
    // facet actions
    $("#clear-facets").click(function() {
        doAction("clear_fq");
        return false;
    });
    $(".add-facet").click(function() {
        doAction("add_fq", $(this).attr("rel"));
        return false;
    });
    $(".remove-facet").click(function() {
        doAction("remove_fq", $(this).attr("rel"));
        return false;
    });
    
    // toggle facets
    $(".mainmenu-heading").click(function(){
        $(this).next().toggle();
        return false;
    });
    
    // toggle advanced facets
    $(".advanced").click(function(){
        var icon = $(this).children("span");
        icon.toggleClass("ui-icon-triangle-1-e");
        icon.toggleClass("ui-icon-triangle-1-s");
        $(this).children("div").toggle();
        return false;
    });
    
    // truncate descriptions
    $("p.item-description").truncate(500, {
        trail: [ '... <a href="#" class="truncate_show">more</a>',
                 ' <a href="#" class="truncate_hide">less</a>' ]
    });
});
</script>
