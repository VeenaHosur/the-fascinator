<script type="text/javascript" src="$portalPath/js/tree/jquery.tree.min.js"></script>
#set($pageTitle = 'Detail')
#if($self.solrResponse.get("response/numFound") == 0)
<h2 id="page-heading">Page not found</h2>
<p>Please try a different <a href="$portalPath/search">search</a>.</p>
#else
#set($meta = $self.metadata)
#set($oid = $self.object.id)
#set($filenameNoExt = $self.getFilePathWithoutExt($oid))
#set($hasPreview = $self.getPreview($oid))
#set($title = $meta.getField("dc_title"))
#set($description = $meta.getField("dc_description"))
#set($error = $self.getErrorPayload())
#if($title == "")
  #set($title = $self.getFileName($oid))
#end
##<h2 id="page-heading">$title</h2>


<table class="layout" width="10px">
  <tbody>
    <tr>
      <td class="leftcol">
        <div class="columnbox">
          <div class="mainmenu">
            <div class="mainmenu-top"></div>
            <div class="mainmenu-heading">Public Memory Research Centre</div>
            <ul class="menu-list">
              <li><a href="$portalPath/home">Home</a></li>
              <li><a href="$portalPath/search">Search</a></li>
              <li><a href="$portalPath/help">Help</a></li>
            </ul>
          </div>
          <div class="mainmenu">
            <div class="mainmenu-top"></div>
            <div class="mainmenu-heading">Actions</div>
            <ul class="menu-list">
                #if(!$self.isMetadataOnly())
                  <li><a id="open-this" href="$portalPath/detail/$oid">Open file</a></li>
                #end
                <li><a id="reharvest" href="$portalPath/detail/$oid">Re-Harvest...</a></li>
            </ul>
          </div>
          <div class="mainmenu">
            <div class="mainmenu-top"></div>
            <div class="mainmenu-heading">Downloads</div>
            <ul class="menu-list">
              <li><a href="$portalPath/download/$self.getPayLoadUrl($self.getFileName($oid))">$self.getFileName($oid)</a></li>
            </ul>
          </div>
          <!--<div class="mainmenu">
            <div class="mainmenu-top"></div>
            <div class="mainmenu-heading">Metadata</div>
            #set($pageHeader="#parse($page.getTemplate('detail-dc-meta.vm'))")
            <div class="block">
              <dl class="meta">
              #foreach($key in $dc.keySet())
                <dt>$self.formatName($key)</dt>
                #set($valueList = $dc.get($key))
                <dd>
                  <ul>
                  #foreach($value in $valueList)
                    <li>$value</li>
                  #end
                  </ul>
                </dd>
              #end
              </dl>
            </div>
          </div>
          <div class="mainmenu">
            <div class="mainmenu-top"></div>
            <div class="mainmenu-heading">Attachments</div>
            <ul class="menu hidden">
            #foreach($payload in $self.object.payloadList)
              #set($pid = $payload.id)
              #set($payloadType = $payload.type.toString())
              <li class="payload" rel="$payload.contentType">
                <a href='$portalPath/download/$self.encode($oid)/$self.encode($pid)' rel="$payloadType" target="blank" title="$payload.contentType">$payload.id</a>
              </li>
            #end
            </ul>
          </div>
          -->
        </div>
      </td>
      <td class="middlecol">
        <div class="detail">
        #if($self.solrResponse.get("response/numFound") == 0)
          #set($pageTitle = "Not found")
          #set($breadcrumb = "Not found")
          <h1 class="content-title">Page not found</h1>
          <h2>There is no media matching your request.</h2>
          <p>You have been redirected to this page because one of the following occurred:</p>
          <ul type="disc">
            <li>It is possible the URL was misspelled or typed incorrectly.</li>
            <li>You have requested an item that no longer exists.</li>
          </ul>
          <p>Return to the <a href="$portalPath/home">Public Memory Research Centre</a>.</p>
        #else
          #set($oid = $self.object.id)
          #set($title = $self.metadata.getField("dc_title"))
          #set($pageTitle = $title)
          #set($breadcrumb = '<a href="' + $portalPath  + '/search">Search</a> &gt; ' + $title)
          <h1 class="content-title">$title</h1>
          <div id="preview" class="box articles">
            <h2>Preview</h2>
            <div class="results-list">
                <div class="result">
                    <h2>Tags:</h2>
                </div>
            </div>
            <div id="anno-root" class="content-preview">
              <span class="mimetype" rel="$self.mimeType"></span>
              <div class="first article clearfix">
            #if($self.mimeType.startsWith("audio/") || $self.mimeType.startsWith("video/"))
                <!-- <input class='player_clear_fragment' type='button' value='Reset' /> -->
                <table>
                  <tbody>
                    <tr>
                      <td id="player-container"></td>
                      <td>
                        <div class="video-results-list">
                          <div class="video-result-list" anotar-uri="$portalPath/$self.object.id">
                          </div>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
            #else
                <h3 class="title-heading">$title</h3>
                <div class="content-preview-inline" width="100px">$!self.payloadContent</div>
                <div class="annotatable">Comment on this document:</div>
                <script type="text/javascript" src="$portalPath/js/viewer.js"></script>
              </div>
            #end
            </div>
          </div>
          
        #end
        </div>
      </td>
    </tr>
  </tbody>
</table>
<div class="clear"><!--clear--></div>
#if($self.mimeType.startsWith("audio/") || $self.mimeType.startsWith("video/"))
<script type="text/javascript" src="$portalPath/flowplayer/flowplayer-3.1.4.min.js"></script>
<script type="text/javascript" src="$portalPath/flowplayer/flowplayer.controls-3.0.2.js"></script>
<script type="text/javascript" src="$portalPath/js/anotar/video.annotate.js"></script>
#end
#if($self.mimeType.startsWith("image/"))
<script type="text/javascript" src="$portalPath/js/anotar/image.annotate.js"></script>
<script language="javascript">
    $(window).load(function() {
        $("#toAnnotate").annotateImage({
            editable: true,
            saveUrl: "$portalPath/actions/anotar.ajax?action=save-image&rootUri=$oid",
            getUrl: "$portalPath/actions/anotar.ajax?action=get-image&rootUri=$oid"
        });
    });
</script>
#end
<script type="text/javascript" src="$portalPath/js/tree/jquery.tree.min.js"></script>
<script type="text/javascript" src="$portalPath/js/autocomplete/lib/jquery.ajaxQueue.js"></script>
<script type="text/javascript" src="$portalPath/js/autocomplete/lib/jquery.bgiframe.js"></script>
<script type="text/javascript" src="$portalPath/js/autocomplete/jquery.autocomplete.pack.js"></script>
<script type="text/javascript">
$(function() {
    var oid = "$oid";
    var filenameNoExt = "$filenameNoExt";
    function fixLinks(baseUrl, selector, attrName) {
        $(selector).each(function() {
            var attr = $(this).attr(attrName);
            if (attr != null) {
                if (attr.indexOf("#") != 0 && attr.indexOf("://") == -1) {
                    var relUrl = "$portalPath/download/$self.object.id/";
                    var tmpUrl = baseUrl.substring(baseUrl.indexOf("/", 8));
                    tmpUrl = tmpUrl.replace(relUrl, "");
                    tmpUrl = tmpUrl.substring(0, tmpUrl.lastIndexOf("/")+1);
                    $(this).attr(attrName, escape(relUrl + tmpUrl + attr));
                }
            }
        });
    }
    gFixLinks = fixLinks;
    fixLinks("", "div.content-preview-inline a", "href");
    fixLinks("", "div.content-preview-inline img", "src");

    $("#open-this").click(function() {
        jQuery.post("$portalPath/open.ajax", { func: "open-file", file: "$oid" } );
        return false;
    });

    $("#reharvest").click(function() {
        jQuery.post("$portalPath/reharvest.ajax", { func: "reharvest", file: "$oid" } );
        return false;
    });

    function addRendition(href, label) {
        $("#actions").append('<li><a href="' + href + '" target="blank">' + label + '</a></li>');
    }
    $('li.payload[rel="application/pdf"] a:first').each(function() {
        addRendition($(this).attr("href"), "PDF version");
    });
    $("span.slide-link > a").each(function() {
        addRendition($(this).attr("href"), "View slide show");
    });
    $("div.rendition-links").remove();

    var player;
    var mimeType = "$self.mimeType";
    //<a class="image" href="' + src + '" ">
    if (mimeType.indexOf("image/") == 0) {
        var src = "$hasPreview";
        if (src == "")
            src = "$portalPath/download/$oid";
        else
            src = "$portalPath/download/$self.encode($oid)/" + src
        $("div.content-preview div.article").html(
            '<div class="annotatable"><div class="image">' +
                '<img class="image" id="toAnnotate" src="' + src + '" style="max-width: 900px;" />' +
            '</div><div class="clear"></div></div>');
    } else if (mimeType.indexOf("audio/") == 0 || mimeType.indexOf("video/") == 0) {
        var height = 300;
        if (mimeType.indexOf("audio/") == 0) {
            height = 24;
        }

        var style = "display: block; width: 425px; height: " + height + "px";
        //var style = "display: block; width: 500px; height: 300px";
        var filename = oid.substring(oid.lastIndexOf("/") + 1);
        var ext = filename.substring(filename.lastIndexOf(".") + 1).toLowerCase();

        var hasFlv = "$self.hasFlv()";
        if (hasFlv!='') {
            filename = hasFlv;
        }
        
        if (hasFlv!='' || ext=="mp3" || ext=="m4a") {
            var href = "$portalPath/download/$oid/" + filename;
            var player1 = '<div href="' + href + '" id="player" style="' + style + '"></div>'; 
            $("#player-container").attr("style", style).html(player1);
            player = flowplayer("player", "$portalPath/flowplayer/flowplayer-3.1.5.swf",
                { clip: { autoPlay: false, autoBuffering: true },
                  play: {
                    label: "Play",
                    replayLabel: "Click to play again"
                    }
                  //plugins: {controls: null} 
                }); //.controls("hulu", {duration: 25});
        } else {
            var error = "$self.hasError()";
            if (hasFlv=="false") {
            	$("div.content-preview div.article").empty().append("No preview available");
            }
        }
    }

    $("#player_seek_start").live("click", function() {
        player.seek(0);
    });
    $("#player_rewind").live("click", function() {
        player.seek(player.getTime() - 1);
    });
    $("#player_play").live("click", function() {
        player.toggle();
    });
    $("#player_forward").live("click", function() {
        player.seek(player.getTime()+1);
    });
    $("#player_seek_end").live("click", function() {
        player.seek(player.getClip().fullDuration-1);
        player.pause();
    });
    
    $("#player_mark_start_time").live("click", function() {
        $("#txtStartMark").attr("value", player.getTime());
        $("#player_mark_end_time").attr("disabled", false);
        $("#txtEndMark").attr("disabled", false);
    });
    $("#player_mark_end_time").live("click", function() {
        $("#txtEndMark").attr("value", player.getTime());
        uri = player.getClip().url + "#";
        start = $('#txtStartMark').val();
        end = $('#txtEndMark').val()
        if (start != "" && end != "") {
            //Use Normal Play Time as described in http://www.ietf.org/rfc/rfc2326.txt
            uri += "t=npt:";
            if (start != "" && start > 0) {
                uri += start + "s"
                if (player.getClip().duration < start) {
                    //warning += "<li>The requested start-point is greater than the video's duration.</li>";
                }
            }
            if (end != "") {
                uri += "," + end + "s";
                if (player.getClip().duration < end) {
                    //warning += "<li>The requested end-point is greater than the video's duration.</li>";
                }
            }
        }
        $(".video-result-list").attr("rel", uri);
    });
    
    $(".player_clear_fragment").live("click", function() {
        $("#txtStartMark").attr("value", "");
        $("#txtEndMark").attr("value", "");
        $("#media_clip").attr("rel", "");
        if (player.getClip()) {
            player.pause();
            player.getClip().update({duration:player.getClip().fullDuration});
        }
    });
    
    $("#player_play_fragment").live("click", function() {
        player.pause();
        player.seek($('#txtStartMark').val());
        player.getClip().update({duration:$('#txtEndMark').val()});
        player.play();
    });
    
    $(".player_play_clip").live("click", function() {
        player.pause();
        var startTime = $(this).siblings(".startTime").text().replace("s", "");
        var endTime = $(this).siblings(".endTime").text().replace("s", "");
        player.seek(startTime);
        player.getClip().update({duration:endTime});
        player.play();
    });
});
</script>
<script type="text/javascript" src="$portalPath/js/anotar/json2.js"></script>
<script type="text/javascript" src="$portalPath/js/anotar/anotar-0.1.js"></script>
<script type="text/javascript">
    $(function(){
        // Tags annotation
        var tags = new Anotar();
        tags.setType("Tag");
        //tags.setConfig("debug", true);
        tags.setConfig("doc_root", ".results-list");
        tags.setConfig("tag_list", ".result h2"); 
        tags.setConfig("page_uri", "$self.object.id");
        tags.setConfig("anno_type", "http://www.purl.org/anotar/ns/type/0.1#Tag");
        tags.setConfig("style_prefix", "tags-");
        tags.setConfig("proxy_required", false);
        tags.setConfig("interface_label", " <img src='$portalPath/images/icons/add.png'/>");
        tags.setConfig("interface_visible", true);
        tags.setConfig("form_prepend", true);
        tags.setConfig("form_custom", "<div class='myTags float-right'>Tag this:" +
          "<textarea></textarea>" +
          "<img src='$portalPath/images/icons/tick.png' class='myTag-submit'/>&#160;" +
          "<img src='$portalPath/images/icons/cross.png' class='myTag-cancel'>" +
        "</div>");
        tags.setConfig("form_cancel", ".myTag-cancel");
        tags.setConfig("form_submit", ".myTag-submit");
        tags.setConfig("server_address", "$portalPath/actions/anotar.ajax");
        tags.setConfig("server_mode", "fascinator");
        tags.setConfig("disable_replies", true);
        tags.init($); 
        
        #if($self.mimeType.startsWith("audio/") || $self.mimeType.startsWith("video/"))
        // Video annotation
        var videoAnoLabel = "<img src='$portalPath/images/icons/comment_add.png'/>&#160;Comment on this video:";
        var videoAno = new Anotar();
        //videoAno.setConfig("debug", true);
        videoAno.setConfig("label", videoAnoLabel);
        videoAno.setConfig("object_literal", "$self.object.id"); 
        videoAno.setConfig("page_uri", "$portalPath/$self.object.id");
        videoAno.setConfig("doc_root", ".video-results-list");
        videoAno.setConfig("tag_list", ".video-result-list");
        videoAno.setConfig("uri_attr", "anotar-uri");
        videoAno.setConfig("reply_label", " <img src='$portalPath/images/icons/comments_add.png'/>");
        videoAno.setConfig("hash_type", "http://www.w3.org/TR/2009/WD-media-frags-20091217");
        videoAno.setConfig("hash_function", function(node) {
            var rel = node.attr("rel");
            if (rel == null) { rel = "$oid"; }
            return rel;
        });
        videoAno.setConfig("style_prefix", "anno-");
        videoAno.setConfig("proxy_required", false);
        videoAno.setConfig("interface_label", videoAnoLabel);
        videoAno.setConfig("interface_visible", true);
        videoAno.setConfig("form_custom", "media_clip_form");
        videoAno.setConfig("form_cancel", ".myTag-cancel");
        videoAno.setConfig("form_submit", ".myTag-submit");
        videoAno.setConfig("server_address", "$portalPath/actions/anotar.ajax");
        videoAno.setConfig("server_mode", "fascinator");
        videoAno.setConfig("disable_replies", false);
        videoAno.setConfig("display_custom", "media_clip_comment");
        videoAno.init($);
        
        $("#media_clip textArea").live("focus", function() {
            var replies = $("#media_clip").prev("blockquote.anno-inline-annotation-quote")
                                          .find(".anno-anno-children");
            if (replies.length > 0) {
                $(".annotate_scope").hide();
            } else {
                $(".annotate_scope").show();
            }
            return false;
        });
        #else
        // Comment annotation
        var notes = new Anotar();
        //notes.setConfig("debug", true);
        notes.setConfig("object_literal", "$self.object.id");
        notes.setConfig("page_uri", "$portalPath/$self.object.id");
        #if($page.authentication.is_logged_in())
        notes.setConfig("creator", "$page.authentication.get_name()");
        notes.setConfig("creator_uri", null);
        #end
        notes.setConfig("tag_list", "p, h1, h2, h3, h4, h5, h6, .annotatable");
        notes.setConfig("proxy_required", false);
        notes.setConfig("interface_label", " <img src='$portalPath/images/icons/comment_add.png'/> Comments:");
        notes.setConfig("reply_label", " <img src='$portalPath/images/icons/comments_add.png'/>");
        notes.setConfig("server_address", "$portalPath/actions/anotar.ajax");
        notes.setConfig("server_mode", "fascinator");
        notes.setConfig("interface_visible", true);
        notes.init($);
        #end
    });
</script>
#if($self.mimeType.startsWith("audio/") || $self.mimeType.startsWith("video/"))
<script type="text/html" id="media_clip_form">
  <div id="media_clip">
    <table>
      <tr>
        <td colspan="2" class="annotate_scope">
          <input type="radio" name="annotate_scope" id="annotate_all" checked="true"
                 onclick="$('.annotate_clip').hide()" />
          <label for="annotate_all">Comment on the whole video</label><br/>
          <input type="radio" name="annotate_scope" id="annotate_clip"
                 onclick="$('.annotate_clip').show()" />
          <label for="annotate_clip">Select a portion (clip) to annotate</label>
        </td>
      </tr>
      <tr class="hidden annotate_clip">
        <td colspan="2">
          <input class="player_clear_fragment" type="button" value="Reset" />
          <input id="player_seek_start" type="button" value="&lt;&lt;" />
          <input id="player_rewind" type="button" value="&lt;" />
          <input id="player_play" type="button" value="Play/Pause" />
          <input id="player_forward" type="button" value="&gt;" />
          <input id="player_seek_end" type="button" value="&gt;&gt;" />
        </td>
      </tr>
      <tr class="hidden annotate_clip">
        <td><input id="player_mark_start_time" type="button" value="Mark start time" value=""/></td>
        <td><input type="text" id="txtStartMark" value=""/></td>
      </tr>
      <tr class="hidden annotate_clip">
        <td><input id="player_mark_end_time" type="button" value="Mark end time" value="" disabled="true"/></td>
        <td><input type="text" id="txtEndMark" value="" disabled="true"/></td>
      </tr>
      <tr class="hidden annotate_clip">
        <td colspan="2"><input id="player_play_fragment" type="button" value="Play Clip" /></td>
      </tr>
      <tr><td>Comment:</td><td><textArea></textArea></td></tr>
      <tr><td colspan="2">
        <button class="myTag-cancel">Cancel</button>&#160;
        <button class="myTag-submit">Submit</button>
      </tr>
    </table>
  </div>
</script>
<script type="text/html" id="media_clip_comment">
  <%
  var startTime = "";
  var endTime = "";
  if (locator != null) {
    var npt = locator.split("#t=npt:");
    if (npt.length > 1) {
        npt = npt[1].split(",");
        startTime = npt[0];
        if (startTime.length == 0) { startTime = "0s"; }
        endTime = npt[1];
        if (endTime.length == 0) { endTime = "0s"; }
    }
  }
  %>
  <div class="<%=style%>inline-annotation <%=toggle%>" id="<%=id%>">
      <input name="rootUri" value="<%=root%>" type="hidden"/>
      <div class="<%=style%>orig-content" style="display:none;"><%=original%></div>
      <div class="<%=style%>anno-info">
        Comment by: <span class="<%=style%>anno-creator"><%=creator%></span>
         &nbsp; <span class="<%=style%>anno-date"><%=date%></span>
      </div>
      <% if (startTime != "" && endTime != "") { %>
      <div class="<%=style%>anno-info">
        <input class="player_play_clip" type="button" value="Play" />
        Clip duration: <span class="startTime"><%=startTime%></span> to
        <span class="endTime"><%=endTime%></span>
      </div>
      <% } %>
      <div>
        <span class="<%=style%>anno-content"><%=content%></span>
      </div>
      <div class="<%=style%>anno-children"><%=children%></div>
  </div>
</script>
#end
#end
